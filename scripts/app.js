/**
 * grrd's Reversi
 * Copyright (c) 2022 Gerard Tyedmers, grrd@gmx.net
 * @license MPL-2.0
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
!function(){"use strict";let e=0;const n=[{lCode:"en",lLang:"English",lDesc:"grrd's Reversi is a free HTML5 Game that works offline.",l2Players:"2 Players",lEasy:"Easy",lMedium:"Medium",lHard:"Hard",lOnline:"Online",lWait:"Waiting for player 2 ...",lWait2:"You can play a 1 player game meanwhile.",lLeft:"Your opponent has left the game.",lHelp:"Place your stone so that at least one of your opponent's stones is flanked by your stones. All of your opponent's stones between your pieces are then flipped over to become your color. \nThe object of the game is to own more stones than your opponent when the game is over. ",lDev:"Developed by Gérard Tyedmers.",lLook:"Have a look at my other games:",lName:"Enter your name",lSelLang:"Select language",lDesign:"Select design",lStyle:["Light","Dark","Automatic"],lShow:"Show possible moves",lSound:"Play sounds",lBegin:" begins.",lOver:"Game over. ",lWin:" wins!",lDraw:" It's a draw!",lTurn:"'s turn.",lNoMove:" can't move. ",lNobodyMove:"Game over, no player can move. ",lNotHere:" can't play here.",lComputer:"Computer",lPlayer:"Player",lStones:"Stones",lGames:"Games",lAgain:"Play again?",lYes:"Yes",lNo:"No"},{lCode:"de",lLang:"Deutsch",lDesc:"grrd's Reversi ist ein kostenloses HTML5 Spiel, welches offline funktioniert.",l2Players:"2 Spieler",lEasy:"Einfach",lMedium:"Mittel",lHard:"Schwer",lOnline:"Online",lWait:"Warte auf Spieler 2 ...",lWait2:"Du kannst unterdessen ein Einzelspieler-Spiel starten.",lLeft:"Dein Gegner hat das Spiel verlassen.",lHelp:"Platziere deinen Stein so, dass er mindestens einen Stein deines Gegners einklemmt. Alle eingeklemmten Steine werden dann umgedreht und wechseln zu deiner Farbe.\nZiel des Spiels ist es, beim Spielende mehr Steine als der Gegner zu haben. ",lDev:"Entwickelt von Gérard Tyedmers.",lLook:"Schau dir auch meine anderen Spiele an:",lName:"Namen eingeben",lSelLang:"Sprache wählen",lDesign:"Design wählen",lStyle:["Hell","Dunkel","Automatisch"],lShow:"Mögliche Züge anzeigen",lSound:"Töne abspielen",lBegin:" beginnt.",lOver:"Spiel beendet. ",lWin:" gewinnt!",lDraw:" Unentschieden!",lTurn:" ist am Zug.",lNoMove:" kann nicht ziehen. ",lNobodyMove:"Spiel beendet, kein Spieler kann ziehen. ",lNotHere:" kann hier nicht spielen.",lComputer:"Computer",lPlayer:"Spieler",lStones:"Steine",lGames:"Spiele",lAgain:"Nochmals spielen?",lYes:"Ja",lNo:"Nein"},{lCode:"fr",lLang:"Francais",lDesc:"grrd's Reversi est un jeu en HTML5 qui fonctionne hors ligne.",l2Players:"2 Joueurs",lEasy:"Simple",lMedium:"Moyens",lHard:"Difficile",lOnline:"En ligne",lWait:"En attente pour joueur 2 ...",lWait2:"Tu peux en attendant commencer un jeu à joueur unique.",lLeft:"Ton adversaire a quitté le match.",lHelp:"Place ton pion de manière à ce qu'il coince au moins un pion de ton adversaire. Tous les pions coincés sont alors retournés et changent de couleur. Le but du jeu est d'avoir plus de pions que l'adversaire à la fin de la partie. ",lDev:"Développé par Gérard Tyedmers.",lLook:"Regarde aussi mes autres jeux:",lName:"Choisir ton nom",lSelLang:"Choisir la langue",lDesign:"Choisir la vue",lStyle:["Clair","Sombre","Automatique"],lShow:"Afficher les mouvements possibles",lSound:"Jouer des sons",lBegin:" commence.",lOver:"Jeu terminé. ",lWin:" gagne!",lDraw:" Match nul!",lTurn:" au tour.",lNoMove:" ne peut pas jouer. ",lNobodyMove:"Jeu terminé, aucun joueur ne peut bouger. ",lNotHere:" ne peut pas jouer ici.",lComputer:"Ordinateur",lPlayer:"Joueur",lStones:"Pions",lGames:"Jeux",lAgain:"Un autre jeu?",lYes:"Oui",lNo:"Non"}];let l,s,t=0,o=0,i=[],a=[],r=[],c=0,u=0,m=!1;const d=["black","white"],g=["<img class='w25' src='images/stone_black.svg' alt='Black'>","<img class='w25' src='images/stone_white.svg' alt='White'>"],h=function(e){return document.getElementById(e)},p=h("iPlayground"),f=h("iMessage");let y=!0,v=!0;const S=function(){const e="modernizr";try{return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}}();function L(){e&&document.documentElement.setAttribute("lang",n[e].lCode),document.querySelector("meta[name='description']").setAttribute("content",n[e].lDesc),document.querySelectorAll("#iStyle option").forEach((function(l,s){l.innerHTML=n[e].lStyle[s]})),document.querySelectorAll('[id^="l"]').forEach((function(l){l.innerHTML=n[e][l.id]}))}function P(){let l;for(const e of p.children)e.className="empty";if(p.children[28].className=d[0],p.children[35].className=d[0],p.children[27].className=d[1],p.children[36].className=d[1],c=0,u=0,t=o,l=E(T()),f.innerHTML=g[t]+" "+a[t]+" "+n[e].lBegin,h("iScore1").innerHTML=g[0]+" "+document.getElementsByClassName(d[0]).length,h("iScore2").innerHTML=document.getElementsByClassName(d[1]).length+" "+g[1],"human"!==i[t]&&"online"!==i[t])k(l);else if(y&&"human"===i[t])for(const e of l)p.children[e.nID].classList.add("ok");m=!1}function b(t){i[0]="human",i[1]=t.target.getAttribute("data-player2"),"online"===i[1]?function(){let t,m;C(h("iPopupOnline")),h("iOnline").disabled=!0,l=io.connect("https://grrd.duckdns.org:4000",{forceNew:!0}),l.heartbeatTimeout=2e4,l.on("connect",(function(){console.log("connected")})),l.on("startgame",(function(c){let u=0;s=c,s.id!==t&&(l.emit("usersend",{to:s.opponent,name:h("iName").value}),t=s.id,document.getElementsByClassName("popup-show").length&&(u+=500),H(h("iPopupOnline")),H(h("iPopupInfo")),H(h("iPopupSettings")),iGame.classList.contains("swipe-in")&&(H(h("iPopupGameOver")),H(h("iPopupLeft")),setTimeout((function(){iTitle.classList.remove("swipe-out"),iGame.classList.remove("swipe-in"),iTitle.classList.add("swipe-out-right"),iGame.classList.add("swipe-in-left")}),u),u+=500),"0"===s.role?(h("iName").value?a[0]=h("iName").value:a[0]=n[e].lPlayer+" 1",a[1]=n[e].lOnline):(h("iName").value?a[1]=h("iName").value:a[1]=n[e].lPlayer+" 1",a[0]=n[e].lOnline),"0"===s.role?(i[0]="human",i[1]="online"):(i[0]="online",i[1]="human"),setTimeout((function(){o=0,r=[0,0],P(),iTitle.classList.remove("swipe-out-right"),iGame.classList.remove("swipe-in-left"),iTitle.classList.add("swipe-out"),iGame.classList.add("swipe-in")}),u))})),l.on("playget",(function(e){1===e.nRound&&c>0&&P(),e.nRound===c+1&&u!==e.nRound&&(u=e.nRound,setTimeout((function(){D(p.children[e.nStone])}),10))})),l.on("userget",(function(e){"0"===s.role?e.name.length>0&&(a[1]=e.name):e.name.length>0&&(a[0]=e.name)})),l.on("quit",(function(){s.id===m||!i.length||"online"!==i[0]&&"online"!==i[1]||(m=s.id,C(h("iPopupLeft")))}))}():(h("iName").value?a[0]=h("iName").value:a[0]=n[e].lPlayer+" 1","human"===i[1]?a[1]=n[e].lPlayer+" 2":a[1]=n[e].lComputer,o=0,r=[0,0],P(),iTitle.classList.remove("swipe-out-right"),iGame.classList.remove("swipe-in-left"),iTitle.classList.add("swipe-out"),iGame.classList.add("swipe-in"))}function M(){"online"!==i[0]&&"online"!==i[1]||(l.disconnect(),h("iOnline").disabled=!1),i=[],iTitle.classList.remove("swipe-out"),iGame.classList.remove("swipe-in"),iTitle.classList.add("swipe-out-right"),iGame.classList.add("swipe-in-left")}function N(e){return{nRow:Math.trunc(e/8),nCol:e%8}}function w(e,n){const l=[[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1]];let s,o=[];if("empty"!==n[e])return o;for(const i of l){let l=[];for(s=1;0<=e+s*i[0]*8+s*i[1]&&e+s*i[0]*8+s*i[1]<=63&&Math.floor(e/8)===Math.floor((e+s*i[1])/8);){if(n[e+s*i[0]*8+s*i[1]]!==d[1-t]){if(n[e+s*i[0]*8+s*i[1]]===d[t]&&l.length>0){o=o.concat(l),o.includes(e)||o.push(e);break}break}l.push(e+s*i[0]*8+s*i[1]),s+=1}}return o}function T(){let e=[];for(const n of p.children)e.push(n.classList.contains(d[0])?d[0]:n.classList.contains(d[1])?d[1]:"empty");return e}function E(e){let n=[],l=[];for(const[s,t]of e.entries())"empty"===t&&(l=w(s,e),l.length>0&&n.push({nID:s,lStones:l}));return n}function D(u){let S=Array.prototype.indexOf.call(u.parentNode.children,u),L=[];const P=w(S,T());for(const e of p.getElementsByClassName("wrong"))e.classList.remove("wrong");if(P.length>0){c+=1,"online"===i[1-t]&&l.emit("playsend",{to:s.opponent,nStone:S,nRound:c});for(const e of P)p.children[e].classList.contains("white")||p.children[e].classList.contains("white")?(p.children[e].className="",p.children[e].className=d[t]):p.children[e].className=d[t];v&&document.getElementById("woosh_sound").play();for(const e of p.children)e.classList.remove("ok");if(0===document.getElementsByClassName("empty").length)h("iFinalMessage").innerHTML=n[e].lOver,h("iPlayer1").innerHTML=g[0]+" "+a[0],h("iPlayer2").innerHTML=a[1]+" "+g[1],h("iFinalScore1").innerHTML=document.getElementsByClassName(d[0]).length,h("iFinalScore2").innerHTML=document.getElementsByClassName(d[1]).length,document.getElementsByClassName(d[0]).length>document.getElementsByClassName(d[1]).length?(r[0]+=1,f.innerHTML=g[0]+n[e].lWin,h("iFinalMessage").innerHTML+=g[0]+" "+a[0]+" "+n[e].lWin):document.getElementsByClassName(d[0]).length<document.getElementsByClassName(d[1]).length?(r[1]+=1,f.innerHTML=g[1]+n[e].lWin,h("iFinalMessage").innerHTML+=g[1]+" "+a[1]+" "+n[e].lWin):(f.innerHTML=n[e].lDraw,h("iFinalMessage").innerHTML+=n[e].lDraw),h("iGames1").innerHTML=r[0],h("iGames2").innerHTML=r[1],setTimeout((function(){o=1-o,m=!0,C(h("iPopupGameOver")),v&&document.getElementById("ding_sound").play()}),500);else if(t=1-t,L=E(T()),L.length>0){if(f.innerHTML=g[t]+" "+a[t]+" "+n[e].lTurn,"human"!==i[t]&&"online"!==i[t])k(L);else if(y&&"human"===i[t])for(const e of L)p.children[e.nID].classList.add("ok")}else if(t=1-t,L=E(T()),L.length>0){if(f.innerHTML=g[1-t]+n[e].lNoMove+g[t]+" "+a[t]+" "+n[e].lTurn,"human"!==i[t]&&"online"!==i[t])k(L);else if(y&&"human"===i[t])for(const e of L)p.children[e.nID].classList.add("ok")}else h("iFinalMessage").innerHTML=n[e].lNobodyMove,h("iPlayer1").innerHTML=g[0]+" "+a[0],h("iPlayer2").innerHTML=a[1]+" "+g[1],h("iFinalScore1").innerHTML=document.getElementsByClassName(d[0]).length,h("iFinalScore2").innerHTML=document.getElementsByClassName(d[1]).length,document.getElementsByClassName(d[0]).length>document.getElementsByClassName(d[1]).length?(r[0]+=1,f.innerHTML=g[0]+n[e].lWin,h("iFinalMessage").innerHTML+=g[0]+" "+a[0]+" "+n[e].lWin):document.getElementsByClassName(d[0]).length<document.getElementsByClassName(d[1]).length?(r[1]+=1,f.innerHTML=g[1]+n[e].lWin,h("iFinalMessage").innerHTML+=g[1]+" "+a[1]+" "+n[e].lWin):(f.innerHTML=n[e].lDraw,h("iFinalMessage").innerHTML+=n[e].lDraw),h("iGames1").innerHTML=r[0],h("iGames2").innerHTML=r[1],setTimeout((function(){o=1-o,m=!0,C(h("iPopupGameOver")),v&&document.getElementById("ding_sound").play()}),500)}else f.innerHTML=g[t]+n[e].lNotHere,p.children[S].classList.add("wrong");h("iScore1").innerHTML=g[0]+" "+document.getElementsByClassName(d[0]).length,h("iScore2").innerHTML=document.getElementsByClassName(d[1]).length+" "+g[1]}function G(e,n){const l=[0,1,2,3,4,5,6,7,8,15,16,23,24,31,32,39,40,47,48,55,56,57,58,59,60,61,62,63],s=[9,10,11,12,13,14,17,22,25,30,33,38,41,46,49,50,51,52,53,54];let o;for(const i of e){if(i.lPlayground=[...n],i.lStones.forEach(e=>{i.lPlayground[e]=d[t]}),i.nScore=i.lStones.length,i.nScore+=20*i.lStones.filter(e=>l.includes(e)).length,l.includes(i.nID)){let e,n,l,s=[],t=1,a=0;for(0===N(i.nID).nRow?(e=0,n=1,l=N(i.nID).nCol):7===N(i.nID).nRow?(e=56,n=1,l=N(i.nID).nCol):0===N(i.nID).nCol?(e=0,n=8,l=N(i.nID).nRow):7===N(i.nID).nCol&&(e=7,n=8,l=N(i.nID).nRow),o=0;o<8;o+=1)s.push(e+o*n);for(o=l-1;o>=0;o-=1){if(i.lPlayground[s[o]]!==i.lPlayground[s[l]]){if("empty"===i.lPlayground[s[o]]){a+=1;break}a+=2;break}t+=1}for(o=l+1;o<8;o+=1){if(i.lPlayground[s[o]]!==i.lPlayground[s[l]]){if("empty"===i.lPlayground[s[o]]){a+=1;break}a+=2;break}t+=1}t>1&&3!==a&&(i.nScore+=20*t),3===a&&(i.nScore-=20)}i.nScore-=3*i.lStones.filter(e=>s.includes(e)).length,i.lPossibleGemstones=[];let e,a,r,c,u=[{nID:0,lDir:[1,1]},{nID:7,lDir:[-1,1]},{nID:56,lDir:[1,-1]},{nID:63,lDir:[-1,-1]}];for(o=0;o<4;o+=1){for(e=0,a=0,r=7;a<7;){for(;i.lPlayground[u[o].nID+e*u[o].lDir[0]+8*a*u[o].lDir[1]]===d[t]&&e<r;)i.lPossibleGemstones.push(u[o].nID+e*u[o].lDir[0]+8*a*u[o].lDir[1]),e+=1;r=e-1,a+=1,e=0}for(e=0,a=0,c=7;e<7;){for(;i.lPlayground[u[o].nID+e*u[o].lDir[0]+8*a*u[o].lDir[1]]===d[t]&&a<c;)i.lPossibleGemstones.push(u[o].nID+e*u[o].lDir[0]+8*a*u[o].lDir[1]),a+=1;c=a-1,e+=1,a=0}}i.lPossibleGemstones=[...new Set(i.lPossibleGemstones)],i.lGemstones=i.lStones.filter(e=>i.lPossibleGemstones.includes(e)),i.nScore+=1e3*i.lGemstones.length,i.lPossibleGemstonesNeighbours=[],"empty"===i.lPlayground[0]&&(i.lPossibleGemstonesNeighbours.push(1),i.lPossibleGemstonesNeighbours.push(9),i.lPossibleGemstonesNeighbours.push(8)),"empty"===i.lPlayground[7]&&(i.lPossibleGemstonesNeighbours.push(6),i.lPossibleGemstonesNeighbours.push(14),i.lPossibleGemstonesNeighbours.push(15)),"empty"===i.lPlayground[56]&&(i.lPossibleGemstonesNeighbours.push(48),i.lPossibleGemstonesNeighbours.push(49),i.lPossibleGemstonesNeighbours.push(57)),"empty"===i.lPlayground[63]&&(i.lPossibleGemstonesNeighbours.push(55),i.lPossibleGemstonesNeighbours.push(54),i.lPossibleGemstonesNeighbours.push(62)),0===i.lGemstones.length&&(i.lGemstonesNeighbours=i.lStones.filter(e=>i.lPossibleGemstonesNeighbours.includes(e)),i.nScore-=80*i.lGemstonesNeighbours.length,i.nScore-=100*i.lGemstonesNeighbours.filter(e=>[9,14,49,54].includes(e)).length)}return e}function k(e){let n=T();e=G(e,n),t=1-t;for(const n of e)n.lPossibleMovesOpponent=E(n.lPlayground),0===n.lPossibleMovesOpponent.length?n.nScore=1e5*Math.abs(n.nScore):(n.lPossibleMovesOpponent=G(n.lPossibleMovesOpponent,n.lPlayground),n.lPossibleMovesOpponent.sort((e,n)=>n.nScore-e.nScore),n.nScore=n.nScore-.8*n.lPossibleMovesOpponent[0].nScore,t=1-t,n.lPossibleMovesOpponent[0].lPossibleMovesPlayer=E(n.lPossibleMovesOpponent[0].lPlayground),n.lPossibleMovesOpponent[0].lPossibleMovesPlayer.length>0&&(n.lPossibleMovesOpponent[0].lPossibleMovesPlayer=G(n.lPossibleMovesOpponent[0].lPossibleMovesPlayer,n.lPossibleMovesOpponent[0].lPlayground),n.lPossibleMovesOpponent[0].lPossibleMovesPlayer.sort((e,n)=>n.nScore-e.nScore),n.nScore=n.nScore+.6*n.lPossibleMovesOpponent[0].lPossibleMovesPlayer[0].nScore),t=1-t);t=1-t,e.sort((e,n)=>n.nScore-e.nScore);let l=e[0].nScore;"hard"!==i[t]&&(l=(e.filter(e=>e.nScore<l)[0]??e[0]).nScore),"medium"===i[t]&&(l=(e.filter(e=>e.nScore<l)[0]??e[e.length-1]).nScore),"easy"===i[t]&&(l=e[e.length-1].nScore);const s=e.filter(e=>e.nScore>=l).length,o=Math.floor(Math.random()*s);setTimeout((function(){D(p.children[e[o].nID])}),1e3)}function I(e){return function(){"human"===i[t]&&D(e)}}function C(e){h("iTitleFieldset").disabled=!0,document.activeElement.blur(),e.classList.remove("popup-init"),e.classList.remove("popup-hide"),e.classList.add("popup-show")}function H(e){h("iTitleFieldset").disabled=!1,e.classList.remove("popup-show"),e.classList.add("popup-hide")}function B(){let e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: light)").matches,n=parseInt(h("iStyle").value);0===n||2===n&&e?document.getElementsByTagName("body")[0].classList.add("light"):document.getElementsByTagName("body")[0].classList.remove("light")}!function(){const n=(function(e){let n=new URLSearchParams(window.location.search);return!!n.has(e)&&n.get(e)}("lang")||navigator.language||navigator.browserLanguage||(navigator.languages||["en"])[0]).substring(0,2).toLowerCase();let l,s;"de"===n?e=1:"fr"===n&&(e=2),S&&(e=null===localStorage.getItem("s_reversi_lang")?e:parseInt(localStorage.getItem("s_reversi_lang")),h("iName").value=null===localStorage.getItem("s_reversi_name")?"":localStorage.getItem("s_reversi_name"),h("iLang").value=e,h("iStyle").value=null===localStorage.getItem("s_reversi_style")?1:parseInt(localStorage.getItem("s_reversi_style")),y=null===localStorage.getItem("s_reversi_show")||"true"===localStorage.getItem("s_reversi_show"),h("iShowMoves").checked=y,v=null===localStorage.getItem("s_reversi_sound")||"true"===localStorage.getItem("s_reversi_sound"),h("iSound").checked=v),L(),"serviceWorker"in navigator&&window.addEventListener("load",(function(){navigator.serviceWorker.register("sw.js").then((function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)}),(function(e){console.log("ServiceWorker registration failed: ",e)}))})),navigator.onLine&&"undefined"!=typeof io||(h("iOnline").disabled=!0),Array.from(document.getElementsByClassName("popup-head")).forEach((function(e){e.appendChild(h("iTitleImg").cloneNode(!0))})),Array.from(document.getElementsByClassName("eBlack")).forEach((function(e){e.addEventListener("click",(function(e){e.target.classList.toggle("vanish"),e.target.parentNode.getElementsByClassName("eWhite")[0].classList.toggle("vanishWhite"),v&&document.getElementById("woosh_sound").play()}))})),setTimeout((function(){!function e(){const n=document.getElementsByClassName("eWhite").length-1,l=Math.floor(Math.random()*(n+1)),s=500+Math.floor(1500*Math.random());document.getElementsByClassName("eWhite")[l].classList.toggle("vanishWhite"),document.getElementsByClassName("eBlack")[l].classList.toggle("vanish"),setTimeout((function(){e()}),s)}()}),1500),h("iInfo").addEventListener("click",(function(){C(h("iPopupInfo"))})),h("iInfoClose").addEventListener("click",(function(){H(h("iPopupInfo"))})),h("iSettings").addEventListener("click",(function(){C(h("iPopupSettings"))})),h("iSettingsClose").addEventListener("click",(function(){e=h("iLang").value,L(),y=h("iShowMoves").checked,v=h("iSound").checked,S&&(localStorage.setItem("s_reversi_name",h("iName").value),localStorage.setItem("s_reversi_lang",e),localStorage.setItem("s_reversi_show",y),localStorage.setItem("s_reversi_sound",v),localStorage.setItem("s_reversi_style",h("iStyle").value)),H(h("iPopupSettings"))})),h("iOnlineClose").addEventListener("click",(function(){H(h("iPopupOnline"))})),h("iLeftClose").addEventListener("click",(function(){H(h("iPopupLeft")),setTimeout((function(){M()}),500)})),h("iNo").addEventListener("click",(function(){H(h("iPopupGameOver")),H(h("iPopupLeft")),setTimeout((function(){M()}),500)})),h("iYes").addEventListener("click",(function(){H(h("iPopupGameOver")),m&&P()})),h("iLang").addEventListener("change",(function(){e=h("iLang").value,L()})),h("iStyle").addEventListener("change",(function(){B()})),Array.from(document.getElementsByClassName("list-button")).forEach((function(e){e.addEventListener("click",b)})),h("iClose").addEventListener("click",M);for(l=0;l<64;l+=1)s=document.createElement("div"),p.appendChild(s),s.onclick=I(s);try{window.matchMedia("(prefers-color-scheme: light)").addEventListener("change",e=>{B()})}catch(e){console.log(e.message)}B()}()}();